<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoHub Vessel & Customer Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            text-align: center;
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .controls {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border-radius: 0 0 15px 15px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-group label {
            font-weight: bold;
            color: #4a5568;
            font-size: 0.9rem;
        }

        select, input {
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: linear-gradient(135deg, #c53030 0%, #9c2626 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }

        .btn-import {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-import:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .vessel-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .vessel-card:hover {
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            transform: translateY(-5px);
        }

        .vessel-header {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 1.5rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .vessel-header:hover {
            background: linear-gradient(135deg, #c53030 0%, #9c2626 100%);
        }

        .vessel-title {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vessel-info {
            margin-top: 0.5rem;
            opacity: 0.9;
            font-size: 1rem;
        }

        .collapse-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .vessel-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .vessel-content {
            padding: 2rem;
            max-height: none; /* FIXED: Remove height restriction */
            overflow: visible; /* FIXED: Allow content to be fully visible */
            transition: all 0.5s ease;
        }

        .vessel-content.collapsed {
            max-height: 0;
            padding: 0 2rem;
            overflow: hidden;
        }

        .customer-card {
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .customer-card:hover {
            border-color: #e53e3e;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.1);
        }

        .customer-header {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .customer-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
        }

        .customer-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .customer-notes {
            font-size: 0.9rem;
            color: #4a5568;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            min-height: 2rem;
            resize: vertical;
        }

        .customer-notes:focus {
            outline: none;
            border-color: #e53e3e;
            box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.1);
        }

        .eta-badge {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer; /* ADDED: Make ETA clickable */
            transition: all 0.3s ease;
        }

        .eta-badge:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-1px);
        }

        .port-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .inland-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .inland-yes {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .inland-no {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
        }

        .inland-unknown {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .tasks-container {
            margin-top: 1rem;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tasks-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2d3748;
        }

        .show-all-btn {
            background: none;
            border: 2px solid #e53e3e;
            color: #e53e3e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .show-all-btn:hover {
            background: #e53e3e;
            color: white;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .task-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .task-item.incomplete {
            border-color: #fed7d7;
            background: #fffaf9;
        }

        .task-item.in-progress {
            border-color: #fbd38d;
            background: #fffbf0;
        }

        .task-item.completed {
            border-color: #c6f6d5;
            background: #f0fff4;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-number {
            background: #4a5568;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-incomplete {
            background: #fed7d7;
            color: #c53030;
        }

        .status-in-progress {
            background: #fbd38d;
            color: #d69e2e;
        }

        .status-completed {
            background: #c6f6d5;
            color: #38a169;
        }

        .status-not-received,
        .status-unpaid {
            background: #fed7d7;
            color: #c53030;
        }

        .status-received,
        .status-paid {
            background: #c6f6d5;
            color: #38a169;
        }

        .task-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.9rem;
            color: #4a5568;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid #e53e3e;
        }

        .stat-card.arriving-week {
            border-top-color: #4299e1;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e53e3e;
            margin-bottom: 0.5rem;
        }

        .stat-number.arriving-week {
            color: #4299e1;
        }

        .stat-label {
            color: #4a5568;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        /* ADDED: Date input styling */
        .eta-input {
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            width: 100%;
            padding: 0;
        }

        .eta-input:focus {
            outline: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                padding: 1rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .customer-header {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .tasks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚢 AutoHub Dashboard</h1>
        <div class="subtitle">Vessel & Customer Management System</div>
        <div class="subtitle" id="dataSource" style="font-size: 0.9rem; opacity: 0.8;">📊 Loading Dashboard Data...</div>
    </div>

    <div class="controls">
        <div class="controls-grid">
            <div class="filter-group">
                <label for="vesselFilter">Filter by Vessel:</label>
                <select id="vesselFilter" onchange="refreshFilters()">
                    <option value="">All Vessels</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="portFilter">Filter by Port:</label>
                <select id="portFilter" onchange="refreshFilters()">
                    <option value="">All Ports</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter" onchange="refreshFilters()">
                    <option value="">All Statuses</option>
                    <option value="incomplete">Incomplete Tasks</option>
                    <option value="completed">Completed Tasks</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="vesselStatusFilter">Vessel Status:</label>
                <select id="vesselStatusFilter" onchange="refreshFilters()">
                    <option value="active">Active Vessels</option>
                    <option value="completed">Completed Vessels</option>
                    <option value="all">All Vessels</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortFilter">Sort by:</label>
                <select id="sortFilter" onchange="refreshFilters()">
                    <option value="ets">ETS (Earliest First)</option>
                    <option value="eta">ETA (Earliest First)</option>
                    <option value="vessel">Vessel Name</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="etaFromFilter">ETA From:</label>
                <input type="date" id="etaFromFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etaToFilter">ETA To:</label>
                <input type="date" id="etaToFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etsFromFilter">ETS From:</label>
                <input type="date" id="etsFromFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etsToFilter">ETS To:</label>
                <input type="date" id="etsToFilter" onchange="refreshFilters()">
            </div>
            <div>
                <button class="btn" onclick="refreshFilters()" title="Apply current filter settings">🔄 Refresh Filters</button>
                <button class="btn btn-import" onclick="importData()" title="Import fresh data from Google Sheets">📥 Import Fresh Data</button>
                <button class="btn btn-secondary" onclick="exportData()">📊 Export Report</button>
                <button class="btn btn-secondary" onclick="debugFieldNames()" title="Show field names from Google Sheets">🔍 Debug Fields</button>
                <button class="btn btn-secondary" onclick="attemptDateCorrection()" title="Fix dates that show MM/DD instead of DD/MM">📅 Fix Dates</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalVessels">0</div>
                <div class="stat-label">Active Vessels</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCustomers">0</div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat-card arriving-week">
                <div class="stat-number arriving-week" id="arrivingThisWeek">0</div>
                <div class="stat-label">Arriving This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingTasks">0</div>
                <div class="stat-label">Pending Tasks</div>
            </div>
        </div>

        <div id="vesselsContainer">
            <!-- Vessels will be loaded here -->
        </div>
    </div>

    <script>
        // Google Apps Script configuration
        const GOOGLE_APPS_SCRIPT_CONFIG = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbz1YhzmOZHcS97vXiIvKkEBbQCDsun__BFeTkjJZyLgujxoiMn3J1DZY0BmmfHUHwu4/exec',
            spreadsheetId: '1oDjo-CbFuSLllevg3NAJpFuqNDa9OnKVYgvyK2C_S54'
        };

        // Task definitions
        const TASKS = [
            { id: 1, name: "ISF Transmit", description: "Submit Import Security Filing" },
            { id: 2, name: "ISF Match", description: "Verify ISF matches manifest" },
            { id: 3, name: "Entry Created / Validate 7501", description: "Create customs entry and validate forms" },
            { id: 4, name: "Inland Confirmation", description: "Confirm inland transportation requirements" },
            { id: 5, name: "AWIS Invoice to AutoHub", description: "Send invoice to AutoHub" },
            { id: 6, name: "NOA Received", description: "Receive Notice of Arrival from carrier", customStates: ["NOT RECEIVED", "RECEIVED"] },
            { id: 7, name: "NOA to Accounting", description: "Forward NOA to accounting department" },
            { id: 8, name: "Bitrix Updated with ETA", description: "Update customer system with arrival time" },
            { id: 9, name: "Arrival Status Email", description: "Send arrival notification in Bitrix" },
            { id: 10, name: "Check Payment Received in Betrix", description: "Confirm payment received from AutoHub", customStates: ["UNPAID", "PAID"] },
            { id: 11, name: "Submit Entry to customs and for Tacoma, Seattle, and Charleston the Summary Packet", description: "Submit entry to customs" },
            { id: 12, name: "CBP Release", description: "Obtain customs release" },
            { id: 13, name: "Request SSL/Terminal Release", description: "Request steamship line and terminal release" },
            { id: 14, name: "SSL/Terminal Release Confirmed", description: "Confirm release from SSL and terminal" },
            { id: 15, name: "Release Notification to Customer", description: "Notify customer of cargo release" },
            { id: 16, name: "Upload Release Docs to Bitrix", description: "Upload release documents to customer portal" },
            { id: 17, name: "Mark Customs Clear in Bitrix", description: "Update customs clearance status" },
            { id: 18, name: "Dispatch Memo to TCAS", description: "Send dispatch instructions to transport company" },
            { id: 19, name: "REG Docs to CBP for Stamp", description: "Submit registration documents for stamping" },
            { id: 20, name: "REG Docs Uploaded to Bitrix", description: "Upload stamped registration documents" }
        ];

        // Global data storage
        let originalVesselsData = [];
        let vesselsData = [];
        let vesselCollapsedStates = {};
        let rawGoogleSheetsData = null;
        let customerTaskStates = {}; // ADDED: Track task display state per customer

        // Enhanced task field mapping
        function getTaskFieldName(taskId) {
            const fieldNames = {
                1: 'isf_transmit',
                2: 'isf_match', 
                3: 'entry_created',
                4: 'inland_confirm',
                5: 'awis_invoice',
                6: 'noa_received',
                7: 'noa_accounting',
                8: 'bitrix_eta',
                9: 'arrival_email',
                10: 'payment_check',
                11: 'entry_transmitted',
                12: 'cbp_release',
                13: 'ssl_request',
                14: 'ssl_confirmed',
                15: 'release_notification',
                16: 'upload_release_docs',
                17: 'customs_clear_bitrix',
                18: 'dispatch_memo',
                19: 'reg_docs_cbp',
                20: 'reg_docs_bitrix'
            };
            return fieldNames[taskId] || 'unknown';
        }

        // UPDATED: Manual date correction that preserves exact dates
        function correctWronglyInterpretedDate(wrongDate) {
            if (!wrongDate) return null;
            
            // If the date looks like it was wrongly interpreted (e.g., 2025-07-06 instead of 2025-06-07)
            if (typeof wrongDate === 'string' && wrongDate.includes('-')) {
                const parts = wrongDate.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1]; 
                    const day = parts[2];
                    
                    // If month and day are both valid and <= 12, we might need to swap them
                    const monthNum = parseInt(month);
                    const dayNum = parseInt(day);
                    
                    if (monthNum <= 12 && dayNum <= 12 && monthNum !== dayNum) {
                        // Swap month and day to correct DD/MM -> MM/DD error
                        const correctedDate = `${year}-${day.padStart(2, '0')}-${month.padStart(2, '0')}`;
                        console.log(`📅 Date correction: ${wrongDate} → ${correctedDate} (swapped month/day)`);
                        return correctedDate;
                    }
                }
            }
            
            return wrongDate;
        }

        // ADDED: Function to attempt date correction for known problematic dates
        function attemptDateCorrection() {
            console.log('🔧 Attempting to correct wrongly interpreted dates...');
            
            let correctionsMade = 0;
            vesselsData.forEach(vessel => {
                // Correct vessel ETS
                const originalETS = vessel.ets;
                vessel.ets = correctWronglyInterpretedDate(vessel.ets);
                if (vessel.ets !== originalETS) {
                    console.log(`📅 Corrected vessel ${vessel.vessel} ETS: ${originalETS} → ${vessel.ets}`);
                    correctionsMade++;
                }
                
                vessel.customers.forEach(customer => {
                    // Correct customer ETA
                    const originalETA = customer.eta;
                    customer.eta = correctWronglyInterpretedDate(customer.eta);
                    if (customer.eta !== originalETA) {
                        console.log(`📅 Corrected ${customer.name} ETA: ${originalETA} → ${customer.eta}`);
                        correctionsMade++;
                    }
                });
            });
            
            if (correctionsMade > 0) {
                console.log(`✅ Made ${correctionsMade} date corrections`);
                renderDashboard();
                updateStatsOnly();
            } else {
                console.log('ℹ️ No date corrections needed');
            }
        }
        function transformManifestData(manifestData, customerDetails, taskStatus) {
            console.log('🔄 Transforming data...');
            console.log('📊 Manifest rows:', manifestData.length);
            console.log('👥 Customer detail rows:', customerDetails.length);
            console.log('📋 Task status rows:', taskStatus.length);
            
            if (manifestData.length > 0) {
                console.log('📋 Manifest fields:', Object.keys(manifestData[0]));
                // Debug the first row dates
                const firstRow = manifestData[0];
                console.log('📅 First row raw dates:', {
                    ETA: firstRow.ETA,
                    ETS: firstRow.ETS,
                    Customer: firstRow.Customer
                });
            }
            if (taskStatus.length > 0) {
                console.log('📋 Task Status fields:', Object.keys(taskStatus[0]));
            }
            
            const vesselsMap = new Map();
            
            manifestData.forEach(row => {
                const vesselKey = `${row.Vessel}_${row['Voy.']}`;
                
                if (!vesselsMap.has(vesselKey)) {
                    vesselsMap.set(vesselKey, {
                        vessel: row.Vessel,
                        voyage: row['Voy.'],
                        ets: parseManifestDate(row.ETS),
                        customers: []
                    });
                }
                
                const vessel = vesselsMap.get(vesselKey);
                
                const customerDetail = customerDetails.find(c => c.Customer === row.Customer) || {};
                
                let blNumber = '';
                if (row['House No.']) {
                    blNumber = row['House No.'];
                    console.log(`✅ Found BOL from 'House No.' field: ${blNumber}`);
                } else {
                    const possibleBLFields = ['BL No.', 'BL_No', 'BL No', 'BOL', 'bol'];
                    for (const field of possibleBLFields) {
                        if (row[field]) {
                            blNumber = row[field];
                            console.log(`✅ Found BOL in '${field}' field: ${blNumber}`);
                            break;
                        }
                    }
                }
                
                if (!blNumber) {
                    console.warn(`⚠️ No BL number found for customer: ${row.Customer}`);
                }
                
                const taskData = taskStatus.find(t => {
                    const customerMatch = t.Customer === row.Customer || 
                                        String(t.Customer || '').trim().toLowerCase() === String(row.Customer || '').trim().toLowerCase();
                    
                    if (!customerMatch) return false;
                    
                    if (blNumber && t['BL_No']) {
                        const match = String(t['BL_No']).trim() === String(blNumber).trim();
                        if (match) {
                            console.log(`✅ Task data matched for ${row.Customer}, House No./BL_No: ${blNumber}`);
                        }
                        return match;
                    }
                    
                    return false;
                }) || {};
                
                const hasTaskData = Object.keys(taskData).length > 0;
                console.log(`🔍 Customer: ${row.Customer}, BL: ${blNumber}, Task data found: ${hasTaskData}`);
                
                // Parse and debug the customer ETA
                const parsedETA = parseManifestDate(row.ETA);
                console.log(`📅 Customer ${row.Customer} ETA: ${row.ETA} → ${parsedETA} → displays as: ${formatDate(parsedETA)}`);
                
                const customer = {
                    name: row.Customer,
                    bnumber: `B${row['Ref No.']}`,
                    bol: blNumber,
                    email: customerDetail.Email || '',
                    notes: customerDetail.Notes || '',
                    pod: row.Port,
                    eta: parsedETA,
                    inland: customerDetail.Inland || 'UNKNOWN',
                    tasks: {},
                    taskDates: {}
                };
                
                // FIXED: Initialize tasks with proper status normalization
                for (let i = 1; i <= 20; i++) {
                    const taskFieldName = getTaskFieldName(i);
                    
                    let taskValue = null;
                    if (hasTaskData && taskData[taskFieldName] !== undefined && taskData[taskFieldName] !== '') {
                        taskValue = taskData[taskFieldName];
                        console.log(`✅ Found task ${i} (${taskFieldName}): ${taskValue} for ${row.Customer}`);
                    }
                    
                    // FIXED: Normalize task status
                    customer.tasks[i] = normalizeTaskStatus(taskValue, i);
                    
                    const dateField = `${taskFieldName}_date`;
                    if (hasTaskData && taskData[dateField]) {
                        customer.taskDates[i] = taskData[dateField];
                    }
                }
                
                vessel.customers.push(customer);
            });
            
            const result = Array.from(vesselsMap.values());
            console.log('✅ Transformation complete:', result.length, 'vessels');
            return result;
        }

        // FIXED: Normalize task status to handle both UPPERCASE and lowercase
        function normalizeTaskStatus(taskValue, taskId) {
            if (!taskValue) return getDefaultTaskStatus(taskId);
            
            const task = TASKS.find(t => t.id === taskId);
            if (task && task.customStates) {
                // For custom states, keep them as-is
                return taskValue;
            } else {
                // Normalize standard statuses
                const normalizedValue = String(taskValue).toLowerCase();
                if (normalizedValue === 'incomplete') return 'incomplete';
                if (normalizedValue === 'in-progress') return 'in-progress';
                if (normalizedValue === 'completed') return 'completed';
                return 'incomplete'; // Default fallback
            }
        }

        // FIXED: Save task function
        async function saveTaskToGoogleAppsScript(customerName, blNo, taskId, newStatus) {
            try {
                const params = new URLSearchParams({
                    action: 'updateTask',
                    customerName,
                    blNo,
                    taskId,
                    newStatus
                });

                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`✅ Saved task ${taskId} for ${customerName}`);
                    return true;
                } else {
                    console.error('❌ Save failed:', result.error);
                    alert(`Save failed: ${result.error}`);
                    return false;
                }
            } catch (err) {
                console.error('❌ Fetch error:', err);
                alert(`Error saving task: ${err.message}`);
                return false;
            }
        }

        // FIXED: Load data from Google Apps Script
        async function loadFromGoogleAppsScript() {
            try {
                console.log('🔄 Loading ALL current data from Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const textResponse = await response.text();
                const data = JSON.parse(textResponse);
                
                if (data.success === false) {
                    throw new Error(data.error);
                }
                
                if (data.manifestData && data.customerData && data.taskData) {
                    rawGoogleSheetsData = data;
                    
                    const transformedData = transformManifestData(data.manifestData, data.customerData, data.taskData);
                    console.log('✅ ALL current data loaded successfully:', transformedData.length, 'vessels');
                    return transformedData;
                } else {
                    throw new Error('Invalid data structure received');
                }
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                throw error;
            }
        }

        function refreshFilters() {
            console.log('🔄 Refreshing filters (no data loading)...');
            renderDashboard();
            updateStatsOnly();
        }

        // FIXED: Import Data
        async function importData() {
            const dataSourceElement = document.getElementById('dataSource');
            
            if (GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                alert('Please configure Google Apps Script first.');
                return;
            }

            dataSourceElement.textContent = '🔄 Loading ALL current data from Google Sheets...';
            
            try {
                const sheetsData = await loadFromGoogleAppsScript();
                if (sheetsData && sheetsData.length > 0) {
                    vesselsData = sheetsData;
                    originalVesselsData = JSON.parse(JSON.stringify(vesselsData));
                    
                    dataSourceElement.textContent = `✅ ALL current data loaded - ${sheetsData.length} vessel(s) | All task statuses current`;
                    
                    renderDashboard();
                    updateStatsOnly();
                    console.log('✅ ALL current data loaded successfully');
                } else {
                    dataSourceElement.textContent = '⚠️ No data received from Google Sheets';
                }
            } catch (error) {
                console.error('❌ Import error:', error);
                dataSourceElement.textContent = '❌ Import Error - Check Google Apps Script configuration';
                alert('Error importing data. Please check your Google Apps Script configuration.');
            }
        }

        // FIXED: Enhanced task update with proper UI refresh
        function updateTaskStatus(vessel, customer, taskId, newStatus) {
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (!vesselData) return;
            
            const customerData = vesselData.customers.find(c => c.bnumber === customer);
            if (!customerData) return;
            
            // Update local data immediately
            customerData.tasks[taskId] = newStatus;
            
            if (!customerData.taskDates) {
                customerData.taskDates = {};
            }
            
            if (newStatus === 'in-progress' || newStatus === 'completed') {
                customerData.taskDates[taskId] = new Date().toISOString().split('T')[0];
            }
            
            // Save to Google Apps Script (async)
            saveTaskToGoogleAppsScript(customerData.name, customerData.bol, taskId, newStatus);
            
            // FIXED: Refresh ONLY the specific customer's tasks
            const customerId = `${vessel}|${customer}`;
            refreshCustomerTasks(customerId);
            
            updateStatsOnly();
        }

        // ADDED: Function to refresh specific customer's tasks
        function refreshCustomerTasks(customerId) {
            const [vessel, customer] = customerId.split('|');
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            const customerData = vesselData.customers.find(c => c.bnumber === customer);
            
            const tasksContainer = document.getElementById(`tasks-${customerId}`);
            if (tasksContainer) {
                const showAllBtn = tasksContainer.closest('.customer-card').querySelector('.show-all-btn');
                const showingAll = showAllBtn && showAllBtn.textContent.includes('Show Less');
                
                // Maintain the current state (show all or show next 3)
                renderCustomerTasks(tasksContainer, customerId, showingAll);
                
                // Update task count
                const tasksHeader = tasksContainer.closest('.customer-card').querySelector('.tasks-title');
                const nextTasks = getNextTasks(customerData.tasks, 3);
                tasksHeader.textContent = `📋 Next Tasks (${nextTasks.length} pending)`;
                
                if (allTasksCompleted(customerData.tasks)) {
                    tasksHeader.textContent = '✅ All Tasks Completed!';
                    tasksHeader.style.color = '#38a169';
                }
            }
        }

        // FIXED: Date parsing function that preserves exact dates without timezone shifts
        function parseManifestDate(dateValue) {
            if (!dateValue) return null;
            
            console.log(`📅 Raw date input: ${dateValue} (type: ${typeof dateValue})`);
            
            // If it's already a Date object, extract the date parts without timezone conversion
            if (dateValue instanceof Date) {
                // Use getFullYear, getMonth, getDate to avoid timezone issues
                const year = dateValue.getFullYear();
                const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
                const day = dateValue.getDate().toString().padStart(2, '0');
                const convertedDate = `${year}-${month}-${day}`;
                console.log(`📅 Date object conversion: ${dateValue} → ${convertedDate} (preserved exact date)`);
                return convertedDate;
            }
            
            // If it's an ISO string, parse it carefully to avoid timezone shifts
            if (typeof dateValue === 'string' && dateValue.includes('T')) {
                const datePart = dateValue.split('T')[0];
                console.log(`📅 ISO string conversion: ${dateValue} → ${datePart} (preserved exact date)`);
                return datePart;
            }
            
            // Handle raw DD/MM/YYYY format string
            if (typeof dateValue === 'string' && dateValue.includes('/')) {
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    
                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    const convertedDate = `${year}-${month}-${day}`;
                    console.log(`📅 DD/MM/YYYY conversion: ${dateValue} → ${convertedDate} (preserved exact date)`);
                    return convertedDate;
                }
            }
            
            // Handle numeric date values (Excel serial dates)
            if (typeof dateValue === 'number') {
                // Convert Excel serial date to JavaScript Date
                const excelEpoch = new Date(1900, 0, 1);
                const jsDate = new Date(excelEpoch.getTime() + (dateValue - 2) * 24 * 60 * 60 * 1000);
                const year = jsDate.getFullYear();
                const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                const day = jsDate.getDate().toString().padStart(2, '0');
                const convertedDate = `${year}-${month}-${day}`;
                console.log(`📅 Excel serial date conversion: ${dateValue} → ${convertedDate} (preserved exact date)`);
                return convertedDate;
            }
            
            return dateValue;
        }

        function getDefaultTaskStatus(taskId) {
            if (taskId === 6) return 'NOT RECEIVED';
            if (taskId === 10) return 'UNPAID';
            return 'incomplete';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            // Parse the YYYY-MM-DD format without timezone conversion
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed in JavaScript
                    const day = parseInt(parts[2]);
                    
                    // Create date using local timezone to avoid shifts
                    const date = new Date(year, month, day);
                    const formatted = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    console.log(`📅 Format: ${dateString} → ${formatted}`);
                    return formatted;
                }
            }
            
            // Fallback for other formats
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (error) {
                console.error('Date formatting error:', error);
                return dateString;
            }
        }

        // FIXED: Get next tasks function to properly identify incomplete tasks
        function getNextTasks(customerTasks, limit = 3) {
            const nextTasks = [];
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                let isIncomplete = false;
                
                if (task && task.customStates) {
                    // For custom states, check if it's the first state (incomplete)
                    isIncomplete = status === task.customStates[0];
                } else {
                    // For standard states, check if incomplete or in-progress
                    isIncomplete = status === 'incomplete' || status === 'in-progress';
                }
                
                if (isIncomplete) {
                    nextTasks.push(i);
                    if (nextTasks.length >= limit) break;
                }
            }
            return nextTasks;
        }

        function getAllTasks(customerTasks) {
            const allTasks = [];
            for (let i = 1; i <= TASKS.length; i++) {
                allTasks.push(i);
            }
            return allTasks;
        }

        function allTasksCompleted(customerTasks) {
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                
                if (task && task.customStates) {
                    if (status !== task.customStates[task.customStates.length - 1]) {
                        return false;
                    }
                } else {
                    if (status !== 'completed') {
                        return false;
                    }
                }
            }
            return true;
        }

        // FIXED: Cycle task status function
        function cycleTaskStatus(currentStatus, taskId) {
            const task = TASKS.find(t => t.id === taskId);
            
            if (task && task.customStates) {
                const states = task.customStates;
                const currentIndex = states.indexOf(currentStatus);
                const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % states.length;
                return states[nextIndex];
            } else {
                // FIXED: Handle both UPPERCASE and lowercase properly
                const normalizedStatus = String(currentStatus).toLowerCase();
                switch (normalizedStatus) {
                    case 'incomplete': return 'in-progress';
                    case 'in-progress': return 'completed';
                    case 'completed': return 'incomplete';
                    default: return 'incomplete';
                }
            }
        }

        function cycleInlandStatus(currentStatus) {
            switch (currentStatus) {
                case 'UNKNOWN': return 'Y';
                case 'Y': return 'N';
                case 'N': return 'UNKNOWN';
                default: return 'UNKNOWN';
            }
        }

        function getInlandClass(inlandStatus) {
            switch (inlandStatus) {
                case 'Y': return 'inland-yes';
                case 'N': return 'inland-no';
                case 'UNKNOWN':
                default: return 'inland-unknown';
            }
        }

        function getInlandDisplay(inlandStatus) {
            switch (inlandStatus) {
                case 'Y': return 'Yes';
                case 'N': return 'No';
                case 'UNKNOWN':
                default: return 'Unknown';
            }
        }

        function shouldShowTask(taskId, customerData) {
            if (taskId === 18 && customerData.inland === 'N') {
                return false;
            }
            return true;
        }

        // FIXED: Render customer tasks with proper status display
        function renderCustomerTasks(container, customerId, showAll = false) {
            const [vessel, customer] = customerId.split('|');
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            const customerData = vesselData.customers.find(c => c.bnumber === customer);
            
            const tasksToShow = showAll ? 
                getAllTasks(customerData.tasks) : 
                getNextTasks(customerData.tasks, 3);
            
            container.innerHTML = '';
            
            tasksToShow.forEach(taskId => {
                if (!shouldShowTask(taskId, customerData)) return;
                
                const task = TASKS.find(t => t.id === taskId);
                const status = customerData.tasks[taskId] || 'incomplete';
                const taskDate = customerData.taskDates && customerData.taskDates[taskId] ? 
                    formatDate(customerData.taskDates[taskId]) : '';
                
                const taskElement = document.createElement('div');
                
                // FIXED: Proper status normalization for CSS classes
                let cssStatus = status;
                if (task && task.customStates) {
                    cssStatus = status.replace(/\s+/g, '-').toLowerCase();
                } else {
                    cssStatus = String(status).toLowerCase().replace(/\s+/g, '-');
                }
                
                taskElement.className = `task-item ${cssStatus}`;
                taskElement.onclick = () => {
                    const newStatus = cycleTaskStatus(status, taskId);
                    updateTaskStatus(vessel, customer, taskId, newStatus);
                };
                
                let displayStatus = status;
                let statusClass = cssStatus;
                if (!task.customStates) {
                    displayStatus = status.replace(/-/g, ' ').toUpperCase();
                }
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-number">${taskId}</div>
                        <div class="task-status status-${statusClass}">${displayStatus}</div>
                    </div>
                    <div class="task-name">${task.name}</div>
                    <div class="task-description">${task.description}</div>
                    ${taskDate ? `<div class="task-date" style="font-size: 0.8rem; color: #4a5568; margin-top: 0.5rem;">📅 ${taskDate}</div>` : ''}
                `;
                
                container.appendChild(taskElement);
            });
        }

        // FIXED: Function to update ETA
        function updateETA(vessel, bnumber, newETA) {
            try {
                const vesselData = vesselsData.find(v => v.vessel === vessel);
                if (vesselData) {
                    const customerData = vesselData.customers.find(c => c.bnumber === bnumber);
                    if (customerData) {
                        const oldETA = customerData.eta;
                        customerData.eta = newETA;
                        console.log(`✅ Updated ETA for ${bnumber} from ${oldETA} to ${newETA}`);
                        
                        // Re-render the dashboard to show the updated date
                        setTimeout(() => {
                            renderDashboard();
                            updateStatsOnly();
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('❌ Error updating ETA:', error);
            }
        }

        // FIXED: Function to make ETA editable
        function makeETAEditable(element, vessel, bnumber, currentETA) {
            // Prevent event bubbling
            event.stopPropagation();
            
            // Store original content
            const originalContent = element.innerHTML;
            
            try {
                const input = document.createElement('input');
                input.type = 'date';
                input.className = 'eta-input';
                input.value = currentETA;
                input.style.cssText = `
                    background: rgba(255,255,255,0.9);
                    border: 2px solid white;
                    color: #2d3748;
                    font-weight: bold;
                    font-size: 0.9rem;
                    text-align: center;
                    width: 140px;
                    padding: 4px;
                    border-radius: 4px;
                `;
                
                const saveAndRestore = () => {
                    try {
                        if (input.value && input.value !== currentETA) {
                            updateETA(vessel, bnumber, input.value);
                        } else {
                            // Restore original content if no change
                            element.innerHTML = originalContent;
                        }
                    } catch (error) {
                        console.error('Error saving ETA:', error);
                        element.innerHTML = originalContent;
                    }
                };
                
                input.onblur = saveAndRestore;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        element.innerHTML = originalContent;
                    }
                };
                
                element.innerHTML = '';
                element.appendChild(input);
                
                // Focus after a short delay to ensure it's rendered
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 10);
                
            } catch (error) {
                console.error('Error creating ETA editor:', error);
                element.innerHTML = originalContent;
            }
        }

        // Filtering and rendering functions
        function applyFilters(vessels) {
            const vesselFilter = document.getElementById('vesselFilter').value;
            const portFilter = document.getElementById('portFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const vesselStatusFilter = document.getElementById('vesselStatusFilter').value;
            const etaFromFilter = document.getElementById('etaFromFilter').value;
            const etaToFilter = document.getElementById('etaToFilter').value;
            const etsFromFilter = document.getElementById('etsFromFilter').value;
            const etsToFilter = document.getElementById('etsToFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            let filteredVessels = vessels.filter(vessel => {
                const vesselCompleted = isVesselCompleted(vessel);
                if (vesselStatusFilter === 'active' && vesselCompleted) return false;
                if (vesselStatusFilter === 'completed' && !vesselCompleted) return false;
                if (vesselFilter && vessel.vessel !== vesselFilter) return false;

                if (etsFromFilter || etsToFilter) {
                    const vesselEts = new Date(vessel.ets);
                    if (etsFromFilter && vesselEts < new Date(etsFromFilter)) return false;
                    if (etsToFilter && vesselEts > new Date(etsToFilter)) return false;
                }

                let filteredCustomers = vessel.customers.filter(customer => {
                    if (etaFromFilter || etaToFilter) {
                        const customerEta = new Date(customer.eta);
                        if (etaFromFilter && customerEta < new Date(etaFromFilter)) return false;
                        if (etaToFilter && customerEta > new Date(etaToFilter)) return false;
                    }
                    if (portFilter && customer.pod !== portFilter) return false;
                    return true;
                });

                if (filteredCustomers.length === 0) return false;

                if (statusFilter === 'incomplete') {
                    const hasIncompleteCustomers = filteredCustomers.some(customer => {
                        return hasIncompleteTasks(customer.tasks);
                    });
                    if (!hasIncompleteCustomers) return false;
                } else if (statusFilter === 'completed') {
                    const allCustomersCompleted = filteredCustomers.every(customer => {
                        return allTasksCompleted(customer.tasks);
                    });
                    if (!allCustomersCompleted) return false;
                }

                vessel.filteredCustomers = filteredCustomers;
                return true;
            });

            return sortVessels(filteredVessels, sortBy);
        }

        function hasIncompleteTasks(customerTasks) {
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                
                if (task && task.customStates) {
                    if (status === task.customStates[0]) return true;
                } else {
                    if (status === 'incomplete' || status === 'in-progress') return true;
                }
            }
            return false;
        }

        function isVesselCompleted(vessel) {
            if (!vessel.customers || vessel.customers.length === 0) return false;
            return vessel.customers.every(customer => allTasksCompleted(customer.tasks));
        }

        function sortVessels(vessels, sortBy) {
            const sorted = [...vessels];
            switch (sortBy) {
                case 'ets':
                    return sorted.sort((a, b) => new Date(a.ets) - new Date(b.ets));
                case 'eta':
                    return sorted.sort((a, b) => {
                        const aEarliestETA = Math.min(...a.customers.map(c => new Date(c.eta)));
                        const bEarliestETA = Math.min(...b.customers.map(c => new Date(c.eta)));
                        return aEarliestETA - bEarliestETA;
                    });
                case 'vessel':
                    return sorted.sort((a, b) => a.vessel.localeCompare(b.vessel));
                default:
                    return sorted;
            }
        }

        function getVesselETARange(vessel) {
            if (!vessel.customers || vessel.customers.length === 0) return null;
            const etas = vessel.customers.map(c => new Date(c.eta)).sort((a, b) => a - b);
            const earliest = etas[0];
            const latest = etas[etas.length - 1];
            
            if (earliest.getTime() === latest.getTime()) {
                return formatDate(earliest.toISOString().split('T')[0]);
            } else {
                return `${formatDate(earliest.toISOString().split('T')[0])} - ${formatDate(latest.toISOString().split('T')[0])}`;
            }
        }

        function getCurrentWeekDates() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            startOfWeek.setHours(0, 0, 0, 0);
            endOfWeek.setHours(23, 59, 59, 999);
            return { startOfWeek, endOfWeek };
        }

        function countArrivingThisWeek(vessels) {
            const { startOfWeek, endOfWeek } = getCurrentWeekDates();
            let count = 0;
            vessels.forEach(vessel => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                customersToCount.forEach(customer => {
                    const etaDate = new Date(customer.eta);
                    if (etaDate >= startOfWeek && etaDate <= endOfWeek) {
                        count++;
                    }
                });
            });
            return count;
        }

        function updateStatsOnly() {
            const filteredVessels = applyFilters(vesselsData);
            
            const totalVessels = filteredVessels.length;
            const totalCustomers = filteredVessels.reduce((sum, vessel) => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                return sum + customersToCount.length;
            }, 0);
            const arrivingThisWeek = countArrivingThisWeek(filteredVessels);
            let pendingTasks = 0;
            
            filteredVessels.forEach(vessel => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                customersToCount.forEach(customer => {
                    TASKS.forEach(task => {
                        const status = customer.tasks[task.id];
                        if (task.customStates) {
                            if (status === task.customStates[0]) pendingTasks++;
                        } else {
                            if (status === 'incomplete' || status === 'in-progress') pendingTasks++;
                        }
                    });
                });
            });
            
            document.getElementById('totalVessels').textContent = totalVessels;
            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('arrivingThisWeek').textContent = arrivingThisWeek;
            document.getElementById('pendingTasks').textContent = pendingTasks;
        }

        function populateFilters() {
            const vesselFilter = document.getElementById('vesselFilter');
            const portFilter = document.getElementById('portFilter');
            
            const currentVessel = vesselFilter.value;
            const currentPort = portFilter.value;
            
            vesselFilter.innerHTML = '<option value="">All Vessels</option>';
            portFilter.innerHTML = '<option value="">All Ports</option>';
            
            const vessels = [...new Set(vesselsData.map(v => v.vessel))];
            const ports = [...new Set(vesselsData.flatMap(v => v.customers.map(c => c.pod)))];
            
            vessels.forEach(vessel => {
                const option = document.createElement('option');
                option.value = vessel;
                option.textContent = vessel;
                if (vessel === currentVessel) option.selected = true;
                vesselFilter.appendChild(option);
            });
            
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                if (port === currentPort) option.selected = true;
                portFilter.appendChild(option);
            });
        }

        function toggleVessel(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            const vesselInfo = header.querySelector('.vessel-info').textContent;
            const voyageMatch = vesselInfo.match(/Voyage: ([^|]+)/);
            const vesselName = header.querySelector('.vessel-title').textContent.replace('▼', '').replace('▶', '').trim();
            const voyage = voyageMatch ? voyageMatch[1].trim() : '';
            const vesselKey = `${vesselName}_${voyage}`;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                icon.textContent = '▼';
                vesselCollapsedStates[vesselKey] = false;
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                icon.textContent = '▶';
                vesselCollapsedStates[vesselKey] = true;
            }
        }

        function toggleTasksView(customerCard, customerId) {
            const container = customerCard.querySelector('.tasks-grid');
            const button = customerCard.querySelector('.show-all-btn');
            const isShowingAll = button.textContent.includes('Show Less');
            
            if (isShowingAll) {
                button.textContent = '📋 Show All Tasks';
                renderCustomerTasks(container, customerId, false);
            } else {
                button.textContent = '📋 Show Less';
                renderCustomerTasks(container, customerId, true);
            }
        }

        function updateCustomerField(vessel, bnumber, field, value) {
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (vesselData) {
                const customerData = vesselData.customers.find(c => c.bnumber === bnumber);
                if (customerData) {
                    customerData[field] = value;
                    console.log(`Updated ${field} for ${bnumber} to ${value}`);
                }
            }
        }

        function toggleInlandStatus(vessel, bnumber) {
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (vesselData) {
                const customerData = vesselData.customers.find(c => c.bnumber === bnumber);
                if (customerData) {
                    customerData.inland = cycleInlandStatus(customerData.inland);
                    
                    const customerCards = document.querySelectorAll('.customer-card');
                    customerCards.forEach(card => {
                        const bnumberInput = card.querySelector('input[value="' + bnumber + '"]');
                        if (bnumberInput) {
                            const inlandBadge = card.querySelector('.inland-badge');
                            if (inlandBadge) {
                                inlandBadge.className = `inland-badge ${getInlandClass(customerData.inland)}`;
                                inlandBadge.textContent = `Inland: ${getInlandDisplay(customerData.inland)}`;
                            }
                        }
                    });
                    
                    updateStatsOnly();
                }
            }
        }

        function renderDashboard() {
            const container = document.getElementById('vesselsContainer');
            
            // Save collapsed states
            const vesselHeaders = container.querySelectorAll('.vessel-header');
            vesselHeaders.forEach(header => {
                const vesselInfo = header.querySelector('.vessel-info').textContent;
                const voyageMatch = vesselInfo.match(/Voyage: ([^|]+)/);
                const vesselName = header.querySelector('.vessel-title').textContent.replace('▼', '').replace('▶', '').trim();
                const voyage = voyageMatch ? voyageMatch[1].trim() : '';
                const vesselKey = `${vesselName}_${voyage}`;
                vesselCollapsedStates[vesselKey] = header.classList.contains('collapsed');
            });
            
            container.innerHTML = '';
            
            const filteredVessels = applyFilters(vesselsData);
            
            filteredVessels.forEach(vessel => {
                const customersToShow = vessel.filteredCustomers || vessel.customers;
                const sortedCustomers = [...customersToShow].sort((a, b) => new Date(a.eta) - new Date(b.eta));
                
                const vesselCard = document.createElement('div');
                vesselCard.className = 'vessel-card';
                
                const vesselETA = getVesselETARange(vessel);
                
                vesselCard.innerHTML = `
                    <div class="vessel-header" onclick="toggleVessel(this)">
                        <div class="vessel-title">
                            ${vessel.vessel}
                            <span class="collapse-icon">▼</span>
                        </div>
                        <div class="vessel-info">
                            Voyage: ${vessel.voyage} | ETS: ${formatDate(vessel.ets)} | ETA: ${vesselETA || 'N/A'} | ${sortedCustomers.length} Customer(s)
                        </div>
                    </div>
                    <div class="vessel-content">
                        ${sortedCustomers.map(customer => {
                            const customerId = `${vessel.vessel}|${customer.bnumber}`;
                            const nextTasks = getNextTasks(customer.tasks, 3);
                            
                            return `
                                <div class="customer-card">
                                    <div class="customer-header">
                                        <div>
                                            <div class="customer-name">
                                                <input type="text" value="${customer.name}" 
                                                       onchange="updateCustomerField('${vessel.vessel}', '${customer.bnumber}', 'name', this.value)"
                                                       style="border: none; background: transparent; font-size: 1.3rem; font-weight: bold; color: #2d3748; width: 100%; padding: 2px;">
                                            </div>
                                            <div class="customer-details">
                                                B#: <input type="text" value="${customer.bnumber}" 
                                                          onchange="updateCustomerField('${vessel.vessel}', '${customer.bnumber}', 'bnumber', this.value)"
                                                          style="border: none; background: transparent; color: #4a5568; padding: 2px;">
                                                | BOL: <input type="text" value="${customer.bol || ''}" 
                                                             onchange="updateCustomerField('${vessel.vessel}', '${customer.bnumber}', 'bol', this.value)"
                                                             style="border: none; background: transparent; color: #4a5568; padding: 2px;">
                                            </div>
                                            <div class="customer-details">
                                                Email: <input type="email" value="${customer.email || ''}" 
                                                              onchange="updateCustomerField('${vessel.vessel}', '${customer.bnumber}', 'email', this.value)"
                                                              style="border: none; background: transparent; color: #4a5568; padding: 2px; width: 200px;"
                                                              placeholder="Enter email address">
                                            </div>
                                            <div class="customer-details">
                                                Notes: 
                                                <textarea class="customer-notes" 
                                                         onchange="updateCustomerField('${vessel.vessel}', '${customer.bnumber}', 'notes', this.value)"
                                                         placeholder="Add customer notes..."
                                                         rows="2">${customer.notes || ''}</textarea>
                                            </div>
                                        </div>
                                        <div class="eta-badge" onclick="event.stopPropagation(); makeETAEditable(this, '${vessel.vessel}', '${customer.bnumber}', '${customer.eta}')">
                                            ETA: ${formatDate(customer.eta)}
                                        </div>
                                        <div class="port-badge">${customer.pod}</div>
                                        <div class="inland-badge ${getInlandClass(customer.inland)}" 
                                             onclick="toggleInlandStatus('${vessel.vessel}', '${customer.bnumber}')"
                                             style="cursor: pointer;">
                                            Inland: ${getInlandDisplay(customer.inland)}
                                        </div>
                                    </div>
                                    <div class="tasks-container">
                                        <div class="tasks-header">
                                            <div class="tasks-title">📋 Next Tasks (${nextTasks.length} pending)</div>
                                            <button class="show-all-btn" onclick="toggleTasksView(this.closest('.customer-card'), '${customerId}')">📋 Show All Tasks</button>
                                        </div>
                                        <div class="tasks-grid" id="tasks-${customerId}">
                                            <!-- Tasks will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(vesselCard);
                
                // Restore collapsed state
                const vesselKey = `${vessel.vessel}_${vessel.voyage}`;
                const vesselHeader = vesselCard.querySelector('.vessel-header');
                const vesselContent = vesselCard.querySelector('.vessel-content');
                const collapseIcon = vesselCard.querySelector('.collapse-icon');
                
                if (vesselCollapsedStates[vesselKey] === true) {
                    vesselHeader.classList.add('collapsed');
                    vesselContent.classList.add('collapsed');
                    collapseIcon.textContent = '▶';
                }
                
                // Render tasks
                sortedCustomers.forEach(customer => {
                    const customerId = `${vessel.vessel}|${customer.bnumber}`;
                    const tasksContainer = document.getElementById(`tasks-${customerId}`);
                    renderCustomerTasks(tasksContainer, customerId, false);
                });
            });
            
            populateFilters();
        }

        function exportData() {
            alert('Export functionality would be implemented here');
        }

        // ENHANCED: Debug function with date correction option
        async function debugFieldNames() {
            if (!rawGoogleSheetsData) {
                alert('No raw data available. Please click "Import Fresh Data" first.');
                return;
            }
            
            try {
                let debugInfo = '🔍 DEBUG: Google Sheets Field Names & Date Analysis\n\n';
                
                debugInfo += '🔗 FIELD MAPPING:\n';
                debugInfo += '  - Manifest_Data "House No." → Dashboard BOL field\n';
                debugInfo += '  - Task_Status "BL_No" → Matches House No. for task updates\n\n';
                
                if (rawGoogleSheetsData.manifestData && rawGoogleSheetsData.manifestData.length > 0) {
                    debugInfo += '📊 MANIFEST_DATA Fields:\n';
                    Object.keys(rawGoogleSheetsData.manifestData[0]).forEach(field => {
                        debugInfo += `  - "${field}"\n`;
                    });
                    
                    const sampleRow = rawGoogleSheetsData.manifestData[0];
                    debugInfo += '\n📊 Sample Manifest Row (BOL & Date Mapping):\n';
                    if (sampleRow['House No.']) debugInfo += `  - House No.: "${sampleRow['House No.']}" ← THIS goes to Dashboard BOL field\n`;
                    if (sampleRow['BL No.']) debugInfo += `  - BL No.: "${sampleRow['BL No.']}" (different field)\n`;
                    debugInfo += `  - Customer: "${sampleRow.Customer}"\n`;
                    debugInfo += `  - Raw ETA: "${sampleRow.ETA}" (should be DD/MM/YYYY)\n`;
                    debugInfo += `  - Raw ETS: "${sampleRow.ETS}" (should be DD/MM/YYYY)\n`;
                }
                
                if (rawGoogleSheetsData.taskData && rawGoogleSheetsData.taskData.length > 0) {
                    debugInfo += '\n📋 TASK_STATUS Fields:\n';
                    Object.keys(rawGoogleSheetsData.taskData[0]).forEach(field => {
                        debugInfo += `  - "${field}"\n`;
                    });
                    
                    const sampleTaskRow = rawGoogleSheetsData.taskData[0];
                    debugInfo += '\n📋 Sample Task Row (Matching):\n';
                    if (sampleTaskRow['BL_No']) debugInfo += `  - BL_No: "${sampleTaskRow['BL_No']}" ← Should match House No. from Manifest\n`;
                    debugInfo += `  - Customer: "${sampleTaskRow.Customer}"\n`;
                    if (sampleTaskRow.isf_transmit) debugInfo += `  - isf_transmit: "${sampleTaskRow.isf_transmit}"\n`;
                }
                
                debugInfo += '\n📝 Current Dashboard Data:\n';
                if (vesselsData.length > 0 && vesselsData[0].customers && vesselsData[0].customers.length > 0) {
                    const customer = vesselsData[0].customers[0];
                    debugInfo += `  - Name: "${customer.name}"\n`;
                    debugInfo += `  - BOL: "${customer.bol}"\n`;
                    debugInfo += `  - Current ETA: "${customer.eta}" → displays as: ${formatDate(customer.eta)}\n`;
                    debugInfo += `  - Task 1 Status: ${customer.tasks[1]}\n`;
                    debugInfo += `  - Task 2 Status: ${customer.tasks[2]}\n`;
                    debugInfo += `  - Task 3 Status: ${customer.tasks[3]}\n`;
                }
                
                debugInfo += '\n🔧 DATE CORRECTION:\n';
                debugInfo += 'If dates are showing incorrectly (e.g., July 6 instead of June 7),\n';
                debugInfo += 'this usually means Google Sheets interpreted DD/MM as MM/DD.\n\n';
                debugInfo += 'Would you like to attempt automatic date correction?\n';
                debugInfo += '(This will try to swap month/day for dates where both values are ≤12)';
                
                console.log('🔍 DEBUG INFO:', debugInfo);
                
                const userChoice = confirm(debugInfo + '\n\nClick OK to attempt date correction, Cancel to just view debug info.');
                
                if (userChoice) {
                    attemptDateCorrection();
                }
                
            } catch (error) {
                console.error('Debug error:', error);
                alert('Debug error: ' + error.message);
            }
        }

        // FIXED: Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            const dataSourceElement = document.getElementById('dataSource');
            
            try {
                dataSourceElement.textContent = '🔄 Loading current data from Google Sheets...';
                
                const sheetsData = await loadFromGoogleAppsScript();
                if (sheetsData && sheetsData.length > 0) {
                    vesselsData = sheetsData;
                    originalVesselsData = JSON.parse(JSON.stringify(vesselsData));
                    dataSourceElement.textContent = `✅ Current data loaded - ${sheetsData.length} vessel(s) | All task statuses current`;
                    console.log('✅ Dashboard initialized with current Google Sheets data');
                } else {
                    dataSourceElement.textContent = '⚠️ No data found in Google Sheets';
                }
            } catch (error) {
                console.error('Auto-load error:', error);
                dataSourceElement.textContent = '❌ Cannot connect to Google Sheets - Check configuration';
                vesselsData = [];
                originalVesselsData = [];
            }
            
            renderDashboard();
            updateStatsOnly();
        });
    </script>
</body>
</html>

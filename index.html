<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoHub Vessel & Customer Management Dashboard - Compact</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.4;
            font-size: 13px;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }

        .header .subtitle {
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .controls {
            background: white;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
        }

        select, input {
            padding: 0.4rem 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: border-color 0.2s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #dc3545;
        }

        .btn {
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        .btn-import {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .vessel-card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid #e9ecef;
            width: 100%;
        }

        .vessel-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .vessel-header:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
        }

        .vessel-title {
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vessel-info {
            margin-top: 0.25rem;
            opacity: 0.95;
            font-size: 0.8rem;
        }

        .collapse-icon {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .vessel-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .vessel-content {
            padding: 0.75rem;
            max-height: none;
            overflow: visible;
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .vessel-content.collapsed {
            max-height: 0;
            padding: 0 0.75rem;
            overflow: hidden;
        }

        .customer-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            padding: 0.6rem;
            transition: border-color 0.2s ease;
        }

        .customer-card:hover {
            border-color: #dc3545;
        }

        .customer-header {
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            gap: 0.5rem;
            align-items: start;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .customer-badges {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            grid-row: span 2;
        }

        .customer-details-section {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .customer-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 0.25rem;
        }

        .customer-name input {
            border: none;
            background: transparent;
            font-size: 0.9rem;
            font-weight: bold;
            color: #212529;
            width: 100%;
            padding: 1px;
        }

        .customer-details {
            font-size: 0.7rem;
            color: #6c757d;
            margin-bottom: 0.2rem;
        }

        .customer-details input {
            border: none;
            background: transparent;
            color: #6c757d;
            padding: 1px;
            font-size: 0.7rem;
        }

        .customer-notes {
            font-size: 0.7rem;
            color: #6c757d;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 0.4rem;
            margin-top: 0.25rem;
            min-height: 2.5rem;
            width: 100%;
            resize: vertical;
        }

        .eta-badge, .port-badge, .inland-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.7rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .eta-badge {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .eta-badge:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }

        .port-badge {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .inland-yes {
            background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
            color: white;
        }

        .inland-no {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
        }

        .inland-unknown {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .tasks-container {
            margin-top: 0.5rem;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .tasks-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #212529;
        }

        .show-all-btn {
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .show-all-btn:hover {
            background: #dc3545;
            color: white;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.4rem;
        }

        .task-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.4rem;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .task-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-item.incomplete {
            border-color: #f5c6cb;
            background: #fff5f5;
        }

        .task-item.in-progress {
            border-color: #ffeaa7;
            background: #fffbf0;
        }

        .task-item.completed {
            border-color: #c3e6cb;
            background: #f8fff9;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2rem;
        }

        .task-number {
            background: #6c757d;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .task-status {
            padding: 0.15rem 0.4rem;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .status-incomplete {
            background: #f5c6cb;
            color: #721c24;
        }

        .status-in-progress {
            background: #ffeaa7;
            color: #856404;
        }

        .status-completed {
            background: #c3e6cb;
            color: #155724;
        }

        .status-not-received,
        .status-unpaid {
            background: #f5c6cb;
            color: #721c24;
        }

        .status-received,
        .status-paid {
            background: #c3e6cb;
            color: #155724;
        }

        .task-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.1rem;
            font-size: 0.7rem;
        }

        .task-description {
            font-size: 0.65rem;
            color: #6c757d;
            line-height: 1.2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-top: 3px solid #dc3545;
        }

        .stat-card.arriving-week {
            border-top-color: #007bff;
        }

        .stat-card.urgent-tasks {
            border-top-color: #dc3545;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 0.25rem;
        }

        .stat-number.arriving-week {
            color: #007bff;
        }

        .stat-number.urgent-tasks {
            color: #dc3545;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .hidden {
            display: none;
        }

        .eta-input {
            background: rgba(255,255,255,0.9);
            border: 1px solid white;
            color: #212529;
            font-weight: 600;
            font-size: 0.7rem;
            text-align: center;
            width: 100px;
            padding: 2px;
            border-radius: 3px;
        }

        .bol-field {
            color: #6c757d;
            padding: 1px 3px;
            background-color: #f8f9fa;
            border-radius: 2px;
            border: 1px solid #dee2e6;
        }

        .task-date {
            font-size: 0.6rem;
            color: #6c757d;
            margin-top: 0.2rem;
        }

        /* Compact table view for better information density */
        .customer-compact {
            display: grid;
            grid-template-columns: 2fr 1fr auto auto auto;
            gap: 0.5rem;
            align-items: center;
            padding: 0.4rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.75rem;
        }

        .customer-compact:last-child {
            border-bottom: none;
        }

        .customer-compact:hover {
            background-color: #f8f9fa;
        }

        @media (max-width: 1400px) {
            .vessel-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .controls-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .vessel-content {
                grid-template-columns: 1fr;
            }
            
            .customer-header {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
            
            .customer-badges {
                grid-row: auto;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .tasks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö¢ AutoHub Dashboard</h1>
        <div class="subtitle">Vessel & Customer Management System</div>
        <div class="subtitle" id="dataSource" style="font-size: 0.75rem; opacity: 0.8;">üìä Loading Dashboard Data...</div>
    </div>

    <div class="controls">
        <div class="controls-grid">
            <div class="filter-group">
                <label for="vesselFilter">Vessel:</label>
                <select id="vesselFilter" onchange="refreshFilters()">
                    <option value="">All Vessels</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="portFilter">Port:</label>
                <select id="portFilter" onchange="refreshFilters()">
                    <option value="">All Ports</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="refreshFilters()">
                    <option value="">All Statuses</option>
                    <option value="incomplete">Incomplete Tasks</option>
                    <option value="completed">Completed Tasks</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="vesselStatusFilter">Vessel Status:</label>
                <select id="vesselStatusFilter" onchange="refreshFilters()">
                    <option value="active">Active Vessels</option>
                    <option value="completed">Completed Vessels</option>
                    <option value="all">All Vessels</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortFilter">Sort by:</label>
                <select id="sortFilter" onchange="refreshFilters()">
                    <option value="ets">ETS (Earliest First)</option>
                    <option value="eta">ETA (Earliest First)</option>
                    <option value="vessel">Vessel Name</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="etaFromFilter">ETA From:</label>
                <input type="date" id="etaFromFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etaToFilter">ETA To:</label>
                <input type="date" id="etaToFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etsFromFilter">ETS From:</label>
                <input type="date" id="etsFromFilter" onchange="refreshFilters()">
            </div>
            <div class="filter-group">
                <label for="etsToFilter">ETS To:</label>
                <input type="date" id="etsToFilter" onchange="refreshFilters()">
            </div>
            <div>
                <button class="btn" onclick="refreshFilters()" title="Apply current filter settings">üîÑ Refresh</button>
                <button class="btn btn-import" onclick="importData()" title="Import fresh data from Google Sheets">üì• Import</button>
                <button class="btn btn-secondary" onclick="exportData()">üìä Export</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalVessels">0</div>
                <div class="stat-label">Active Vessels</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCustomers">0</div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat-card arriving-week">
                <div class="stat-number arriving-week" id="arrivingThisWeek">0</div>
                <div class="stat-label">Arriving This Week</div>
            </div>
            <div class="stat-card urgent-tasks">
                <div class="stat-number urgent-tasks" id="urgentTasks">0</div>
                <div class="stat-label">Urgent Tasks</div>
            </div>
        </div>

        <div id="vesselsContainer">
            <!-- Vessels will be loaded here -->
        </div>
    </div>

    <script>
        // Google Apps Script configuration
        const GOOGLE_APPS_SCRIPT_CONFIG = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbz1YhzmOZHcS97vXiIvKkEBbQCDsun__BFeTkjJZyLgujxoiMn3J1DZY0BmmfHUHwu4/exec',
            spreadsheetId: '1oDjo-CbFuSLllevg3NAJpFuqNDa9OnKVYgvyK2C_S54'
        };

        // Task definitions - UPDATED task 1 and task 5
        const TASKS = [
            { id: 1, name: "Review Customer Docs and Provide Trucking Quote", description: "Confirmed all required info received from customer and send Trucking Quote" },
            { id: 2, name: "ISF Transmit", description: "Submit Import Security Filing" },
            { id: 3, name: "ISF Match", description: "Verify ISF matches manifest" },
            { id: 4, name: "Entry Created / Validate 7501", description: "Create customs entry and validate forms" },
            { id: 5, name: "Inland Confirmation", description: "Confirm customer wants inland transportation" },
            { id: 6, name: "Update Betrix with Transport Status", description: "If YES, add trucking amount" },
            { id: 7, name: "AWIS Invoice to AutoHub", description: "Send invoice and Trucking Sheet to AutoHub" },
            { id: 8, name: "NOA Received", description: "Receive Notice of Arrival from carrier", customStates: ["NOT RECEIVED", "RECEIVED"] },
            { id: 9, name: "NOA to Accounting", description: "Forward NOA to accounting department" },
            { id: 10, name: "Bitrix Updated with ETA", description: "Update Betrix to reflect ETA on NOA" },
            { id: 11, name: "Arrival Status Email", description: "Send arrival notification in Bitrix" },
            { id: 12, name: "Check Payment Received in Betrix", description: "Confirm payment received from AutoHub", customStates: ["UNPAID", "PAID"] },
            { id: 13, name: "Submit Entry to customs and for Tacoma, Seattle, and Charleston the Summary Packet", description: "Submit entry to customs" },
            { id: 14, name: "CBP Release", description: "Obtain customs release" },
            { id: 15, name: "Request SSL/Terminal Release/LFD", description: "Vessel must have arrived prior to requesting" },
            { id: 16, name: "SSL/Terminal Release Confirmed", description: "Confirm release from SSL and terminal" },
            { id: 17, name: "Release Notification to Customer or Transcar", description: "Notify customer of cargo release" },
            { id: 18, name: "Upload Release Docs to Bitrix", description: "Upload release documents to customer portal" },
            { id: 19, name: "Mark Customs Clear in Bitrix", description: "Update customs clearance status" },
            { id: 20, name: "REG Docs to CBP for Stamp", description: "Submit registration documents for stamping" },
            { id: 21, name: "REG Docs Uploaded to Bitrix", description: "Upload stamped registration documents" }
        ];

        // ADDED: Function to calculate date X days before ETA
        function getDateXDaysBefore(etaDate, daysBefore) {
            if (!etaDate) return null;
            const eta = new Date(etaDate);
            const targetDate = new Date(eta);
            targetDate.setDate(eta.getDate() - daysBefore);
            return targetDate.toISOString().split('T')[0];
        }

        // ADDED: Function to get task-specific description based on customer data
        function getTaskDescription(taskId, customerData) {
            const task = TASKS.find(t => t.id === taskId);
            if (!task) return '';

            switch (taskId) {
                case 7: // AWIS Invoice to AutoHub
                    const invoiceByDate = getDateXDaysBefore(customerData.eta, 7);
                    return `${task.description}\nMust be sent by ${formatDate(invoiceByDate)}`;
                
                case 8: // NOA Received
                    const requestByDate = getDateXDaysBefore(customerData.eta, 5);
                    return `${task.description}\nRequest by ${formatDate(requestByDate)}`;
                
                case 17: // Release Notification
                    return "If no INLAND send to customer - If INLAND send to Transcar with Trucking Spreadsheet";
                
                default:
                    return task.description;
            }
        }

        // Global data storage
        let originalVesselsData = [];
        let vesselsData = [];
        let vesselCollapsedStates = {};
        let rawGoogleSheetsData = null;
        let customerTaskStates = {};
        let taskUpdateQueue = []; // ADDED: Queue for task updates
        let isProcessingTaskUpdates = false; // ADDED: Flag to prevent concurrent updates

        // Enhanced task field mapping
        function getTaskFieldName(taskId) {
            const fieldNames = {
                1: 'review_customer_docs',
                2: 'isf_transmit',
                3: 'isf_match', 
                4: 'entry_created',
                5: 'inland_confirm',
                6: 'update_betrix_transport',
                7: 'awis_invoice',
                8: 'noa_received',
                9: 'noa_accounting',
                10: 'bitrix_eta',
                11: 'arrival_email',
                12: 'payment_check',
                13: 'entry_transmitted',
                14: 'cbp_release',
                15: 'ssl_request',
                16: 'ssl_confirmed',
                17: 'release_notification',
                18: 'upload_release_docs',
                19: 'customs_clear_bitrix',
                20: 'reg_docs_cbp',
                21: 'reg_docs_bitrix'
            };
            return fieldNames[taskId] || 'unknown';
        }

        function transformManifestData(manifestData, customerDetails, taskStatus) {
            console.log('üîÑ Transforming data...');
            console.log('üìä Manifest rows:', manifestData.length);
            console.log('üë• Customer detail rows:', customerDetails.length);
            console.log('üìã Task status rows:', taskStatus.length);
            
            if (manifestData.length > 0) {
                console.log('üìã Manifest fields:', Object.keys(manifestData[0]));
                const firstRow = manifestData[0];
                console.log('üìÖ First row raw dates:', {
                    ETA: firstRow.ETA,
                    ETS: firstRow.ETS,
                    Customer: firstRow.Customer
                });
            }
            if (taskStatus.length > 0) {
                console.log('üìã Task Status fields:', Object.keys(taskStatus[0]));
            }
            
            const vesselsMap = new Map();
            
            manifestData.forEach(row => {
                const vesselKey = `${row.Vessel}_${row['Voy.']}`;
                
                if (!vesselsMap.has(vesselKey)) {
                    vesselsMap.set(vesselKey, {
                        vessel: row.Vessel,
                        voyage: row['Voy.'],
                        ets: parseManifestDate(row.ETS),
                        customers: []
                    });
                }
                
                const vessel = vesselsMap.get(vesselKey);
                
                // UPDATED: Look up customer details by BL_No instead of Customer name
                let blNumber = '';
                if (row['House No.']) {
                    blNumber = row['House No.'];
                    console.log(`‚úÖ Found BOL from 'House No.' field: ${blNumber}`);
                } else {
                    const possibleBLFields = ['BL No.', 'BL_No', 'BL No', 'BOL', 'bol'];
                    for (const field of possibleBLFields) {
                        if (row[field]) {
                            blNumber = row[field];
                            console.log(`‚úÖ Found BOL in '${field}' field: ${blNumber}`);
                            break;
                        }
                    }
                }
                
                // UPDATED: Find customer details by BL_No
                const customerDetail = customerDetails.find(c => c.BL_No === blNumber) || {};
                
                if (!blNumber) {
                    console.warn(`‚ö†Ô∏è No BL number found for customer: ${row.Customer}`);
                }
                
                const taskData = taskStatus.find(t => {
                    if (blNumber && t['BL_No']) {
                        const match = String(t['BL_No']).trim() === String(blNumber).trim();
                        if (match) {
                            console.log(`‚úÖ Task data matched for ${row.Customer}, BL_No: ${blNumber}`);
                        }
                        return match;
                    }
                    
                    return false;
                }) || {};
                
                const hasTaskData = Object.keys(taskData).length > 0;
                console.log(`üîç Customer: ${row.Customer}, BL: ${blNumber}, Task data found: ${hasTaskData}`);
                
                const parsedETA = parseManifestDate(row.ETA);
                console.log(`üìÖ Customer ${row.Customer} ETA: ${row.ETA} ‚Üí ${parsedETA} ‚Üí displays as: ${formatDate(parsedETA)}`);
                
                const customer = {
                    name: row.Customer,
                    bnumber: customerDetail.BNumber || '',
                    bol: blNumber,
                    email: customerDetail.Email || '',
                    notes: customerDetail.Notes || '',
                    pod: row.Port,
                    eta: parsedETA,
                    inland: customerDetail.Inland || 'UNKNOWN',
                    tasks: {},
                    taskDates: {}
                };
                
                for (let i = 1; i <= 21; i++) {
                    const taskFieldName = getTaskFieldName(i);
                    
                    let taskValue = null;
                    if (hasTaskData && taskData[taskFieldName] !== undefined && taskData[taskFieldName] !== '') {
                        taskValue = taskData[taskFieldName];
                        console.log(`‚úÖ Found task ${i} (${taskFieldName}): ${taskValue} for ${row.Customer}`);
                    }
                    
                    customer.tasks[i] = normalizeTaskStatus(taskValue, i);
                    
                    const dateField = `${taskFieldName}_date`;
                    if (hasTaskData && taskData[dateField]) {
                        customer.taskDates[i] = taskData[dateField];
                    }
                }
                
                vessel.customers.push(customer);
            });
            
            const result = Array.from(vesselsMap.values());
            console.log('‚úÖ Transformation complete:', result.length, 'vessels');
            return result;
        }

        function normalizeTaskStatus(taskValue, taskId) {
            if (!taskValue) return getDefaultTaskStatus(taskId);
            
            const task = TASKS.find(t => t.id === taskId);
            if (task && task.customStates) {
                return taskValue;
            } else {
                const normalizedValue = String(taskValue).toLowerCase();
                if (normalizedValue === 'incomplete') return 'incomplete';
                if (normalizedValue === 'in-progress') return 'in-progress';
                if (normalizedValue === 'completed') return 'completed';
                return 'incomplete';
            }
        }

        // UPDATED: Process task update queue to prevent rapid clicking issues
        async function processTaskUpdateQueue() {
            if (isProcessingTaskUpdates || taskUpdateQueue.length === 0) return;
            
            isProcessingTaskUpdates = true;
            
            while (taskUpdateQueue.length > 0) {
                const update = taskUpdateQueue.shift();
                try {
                    console.log(`üì§ Processing task update: Customer: ${update.customerName}, BL: ${update.blNo}, Task: ${update.taskId}`);
                    await saveTaskToGoogleAppsScript(update.customerName, update.blNo, update.taskId, update.newStatus);
                    console.log(`‚úÖ Processed queued task update: ${update.taskId} = ${update.newStatus}`);
                } catch (error) {
                    console.error('‚ùå Error processing queued task update:', error);
                }
                
                // Small delay between updates
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            isProcessingTaskUpdates = false;
        }

        // FIXED: Save task function with queueing
        async function saveTaskToGoogleAppsScript(customerName, blNo, taskId, newStatus) {
            try {
                const params = new URLSearchParams({
                    action: 'updateTask',
                    customerName,
                    blNo,
                    taskId,
                    newStatus
                });

                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`‚úÖ Saved task ${taskId} for ${customerName}`);
                    return true;
                } else {
                    console.error('‚ùå Save failed:', result.error);
                    alert(`Save failed: ${result.error}`);
                    return false;
                }
            } catch (err) {
                console.error('‚ùå Fetch error:', err);
                alert(`Error saving task: ${err.message}`);
                return false;
            }
        }

        // UPDATED: Save customer field function to use BL_No
        async function saveCustomerToGoogleAppsScript(blNo, field, value) {
            try {
                const params = new URLSearchParams({
                    action: 'updateCustomer',
                    blNo,
                    field,
                    value
                });

                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`‚úÖ Saved customer field ${field} for BL_No ${blNo}`);
                    return true;
                } else {
                    console.error('‚ùå Customer save failed:', result.error);
                    return false;
                }
            } catch (err) {
                console.error('‚ùå Customer save error:', err);
                return false;
            }
        }

        // ADDED: Save ETA field function
        async function saveETAToGoogleAppsScript(customerName, newETA) {
            try {
                const params = new URLSearchParams({
                    action: 'updateManifestETA',
                    customerName,
                    newETA
                });

                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`‚úÖ Saved ETA for ${customerName}`);
                    return true;
                } else {
                    console.error('‚ùå ETA save failed:', result.error);
                    return false;
                }
            } catch (err) {
                console.error('‚ùå ETA save error:', err);
                return false;
            }
        }

        async function loadFromGoogleAppsScript() {
            try {
                console.log('üîÑ Loading ALL current data from Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const textResponse = await response.text();
                const data = JSON.parse(textResponse);
                
                if (data.success === false) {
                    throw new Error(data.error);
                }
                
                if (data.manifestData && data.customerData && data.taskData) {
                    rawGoogleSheetsData = data;
                    
                    const transformedData = transformManifestData(data.manifestData, data.customerData, data.taskData);
                    console.log('‚úÖ ALL current data loaded successfully:', transformedData.length, 'vessels');
                    return transformedData;
                } else {
                    throw new Error('Invalid data structure received');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                throw error;
            }
        }

        function refreshFilters() {
            console.log('üîÑ Refreshing filters (no data loading)...');
            renderDashboard();
            updateStatsOnly();
        }

        async function importData() {
            const dataSourceElement = document.getElementById('dataSource');
            
            if (GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                alert('Please configure Google Apps Script first.');
                return;
            }

            dataSourceElement.textContent = 'üîÑ Loading ALL current data from Google Sheets...';
            
            try {
                const sheetsData = await loadFromGoogleAppsScript();
                if (sheetsData && sheetsData.length > 0) {
                    vesselsData = sheetsData;
                    originalVesselsData = JSON.parse(JSON.stringify(vesselsData));
                    
                    dataSourceElement.textContent = `‚úÖ ALL current data loaded - ${sheetsData.length} vessel(s) | All task statuses current`;
                    
                    renderDashboard();
                    updateStatsOnly();
                    console.log('‚úÖ ALL current data loaded successfully');
                } else {
                    dataSourceElement.textContent = '‚ö†Ô∏è No data received from Google Sheets';
                }
            } catch (error) {
                console.error('‚ùå Import error:', error);
                dataSourceElement.textContent = '‚ùå Import Error - Check Google Apps Script configuration';
                alert('Error importing data. Please check your Google Apps Script configuration.');
            }
        }

        // UPDATED: Enhanced task update with queueing - NOW USES BOL NUMBER
        function updateTaskStatus(vessel, customer, bol, taskId, newStatus) {
            console.log(`üîÑ Updating task ${taskId} for vessel: ${vessel}, customer: ${customer}, BOL: ${bol}`);
            
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (!vesselData) {
                console.error(`‚ùå Vessel not found: ${vessel}`);
                return;
            }
            
            // FIXED: Find customer by BOL number, not just name
            const customerData = vesselData.customers.find(c => c.bol === bol);
            if (!customerData) {
                console.error(`‚ùå Customer not found with BOL: ${bol}`);
                return;
            }
            
            console.log(`‚úÖ Found correct customer: ${customerData.name} with BOL: ${customerData.bol}`);
            
            // Update local data immediately
            customerData.tasks[taskId] = newStatus;
            
            if (!customerData.taskDates) {
                customerData.taskDates = {};
            }
            
            if (newStatus === 'in-progress' || newStatus === 'completed') {
                customerData.taskDates[taskId] = new Date().toISOString().split('T')[0];
            }
            
            // Add to queue for processing
            taskUpdateQueue.push({
                customerName: customerData.name,
                blNo: customerData.bol,
                taskId: taskId,
                newStatus: newStatus
            });
            
            // Process queue
            processTaskUpdateQueue();
            
            // Refresh UI - now includes BOL with proper encoding
            const safeBol = encodeURIComponent(bol);
            const customerId = `${vessel}|${customer}|${safeBol}`;
            refreshCustomerTasks(customerId);
            updateStatsOnly();
        }

        function refreshCustomerTasks(customerId) {
            const [vessel, customer, encodedBol] = customerId.split('|');
            const bol = decodeURIComponent(encodedBol);
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            // FIXED: Find customer by BOL number
            const customerData = vesselData.customers.find(c => c.bol === bol);
            
            const tasksContainer = document.getElementById(`tasks-${customerId}`);
            if (tasksContainer) {
                const showAllBtn = tasksContainer.closest('.customer-card').querySelector('.show-all-btn');
                const showingAll = showAllBtn && showAllBtn.textContent.includes('Show Less');
                
                renderCustomerTasks(tasksContainer, customerId, showingAll);
                
                const tasksHeader = tasksContainer.closest('.customer-card').querySelector('.tasks-title');
                const nextTasks = getNextTasks(customerData.tasks, 3);
                tasksHeader.textContent = `üìã Next Tasks (${nextTasks.length} pending)`;
                
                if (allTasksCompleted(customerData.tasks)) {
                    tasksHeader.textContent = '‚úÖ All Tasks Completed!';
                    tasksHeader.style.color = '#28a745';
                }
            }
        }

        function parseManifestDate(dateValue) {
            if (!dateValue) return null;
            
            console.log(`üìÖ Raw date input: "${dateValue}" (type: ${typeof dateValue})`);
            
            if (typeof dateValue === 'string' && dateValue.includes('/')) {
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020) {
                        const convertedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                        console.log(`üìÖ DD/MM/YYYY conversion: "${dateValue}" ‚Üí "${convertedDate}"`);
                        
                        const testDate = new Date(year, month - 1, day);
                        console.log(`üìÖ Verification: ${convertedDate} should display as ${testDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}`);
                        
                        return convertedDate;
                    }
                }
            }
            
            if (dateValue instanceof Date) {
                const year = dateValue.getFullYear();
                const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
                const day = dateValue.getDate().toString().padStart(2, '0');
                const convertedDate = `${year}-${month}-${day}`;
                console.log(`üìÖ Date object conversion: ${dateValue} ‚Üí ${convertedDate}`);
                return convertedDate;
            }
            
            if (typeof dateValue === 'string' && dateValue.includes('T')) {
                const datePart = dateValue.split('T')[0];
                console.log(`üìÖ ISO string conversion: ${dateValue} ‚Üí ${datePart}`);
                return datePart;
            }
            
            if (typeof dateValue === 'string' && dateValue.includes('-') && dateValue.length === 10) {
                console.log(`üìÖ Already in YYYY-MM-DD format: ${dateValue}`);
                return dateValue;
            }
            
            console.log(`üìÖ Fallback parsing for: ${dateValue}`);
            return dateValue;
        }

        function getDefaultTaskStatus(taskId) {
            if (taskId === 8) return 'NOT RECEIVED';  // NOA Received
            if (taskId === 12) return 'UNPAID';       // Check Payment Received
            return 'incomplete';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const day = parseInt(parts[2]);
                    
                    const date = new Date(year, month, day);
                    const formatted = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    console.log(`üìÖ Format: ${dateString} ‚Üí ${formatted}`);
                    return formatted;
                }
            }
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (error) {
                console.error('Date formatting error:', error);
                return dateString;
            }
        }

        function getNextTasks(customerTasks, limit = 3) {
            const nextTasks = [];
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                let isIncomplete = false;
                
                if (task && task.customStates) {
                    isIncomplete = status === task.customStates[0];
                } else {
                    isIncomplete = status === 'incomplete' || status === 'in-progress';
                }
                
                if (isIncomplete) {
                    nextTasks.push(i);
                    if (nextTasks.length >= limit) break;
                }
            }
            return nextTasks;
        }

        function getAllTasks(customerTasks) {
            const allTasks = [];
            for (let i = 1; i <= TASKS.length; i++) {
                allTasks.push(i);
            }
            return allTasks;
        }

        function allTasksCompleted(customerTasks) {
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                
                if (task && task.customStates) {
                    if (status !== task.customStates[task.customStates.length - 1]) {
                        return false;
                    }
                } else {
                    if (status !== 'completed') {
                        return false;
                    }
                }
            }
            return true;
        }

        function cycleTaskStatus(currentStatus, taskId) {
            const task = TASKS.find(t => t.id === taskId);
            
            if (task && task.customStates) {
                const states = task.customStates;
                const currentIndex = states.indexOf(currentStatus);
                const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % states.length;
                return states[nextIndex];
            } else {
                const normalizedStatus = String(currentStatus).toLowerCase();
                switch (normalizedStatus) {
                    case 'incomplete': return 'in-progress';
                    case 'in-progress': return 'completed';
                    case 'completed': return 'incomplete';
                    default: return 'incomplete';
                }
            }
        }

        function cycleInlandStatus(currentStatus) {
            switch (currentStatus) {
                case 'UNKNOWN': return 'Y';
                case 'Y': return 'N';
                case 'N': return 'UNKNOWN';
                default: return 'UNKNOWN';
            }
        }

        function getInlandClass(inlandStatus) {
            switch (inlandStatus) {
                case 'Y': return 'inland-yes';
                case 'N': return 'inland-no';
                case 'UNKNOWN':
                default: return 'inland-unknown';
            }
        }

        function getInlandDisplay(inlandStatus) {
            switch (inlandStatus) {
                case 'Y': return 'Inland: Yes';
                case 'N': return 'Inland: No';
                case 'UNKNOWN':
                default: return 'Inland: Unknown';
            }
        }

        function shouldShowTask(taskId, customerData) {
            // All tasks should be shown for now
            return true;
        }

        function renderCustomerTasks(container, customerId, showAll = false) {
            const [vessel, customer, encodedBol] = customerId.split('|');
            const bol = decodeURIComponent(encodedBol);
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            // FIXED: Find customer by BOL number
            const customerData = vesselData.customers.find(c => c.bol === bol);
            
            const tasksToShow = showAll ? 
                getAllTasks(customerData.tasks) : 
                getNextTasks(customerData.tasks, 3);
            
            container.innerHTML = '';
            
            tasksToShow.forEach(taskId => {
                if (!shouldShowTask(taskId, customerData)) return;
                
                const task = TASKS.find(t => t.id === taskId);
                const status = customerData.tasks[taskId] || 'incomplete';
                const taskDate = customerData.taskDates && customerData.taskDates[taskId] ? 
                    formatDate(customerData.taskDates[taskId]) : '';
                
                const taskElement = document.createElement('div');
                
                let cssStatus = status;
                if (task && task.customStates) {
                    cssStatus = status.replace(/\s+/g, '-').toLowerCase();
                } else {
                    cssStatus = String(status).toLowerCase().replace(/\s+/g, '-');
                }
                
                taskElement.className = `task-item ${cssStatus}`;
                taskElement.onclick = () => {
                    const newStatus = cycleTaskStatus(status, taskId);
                    // FIXED: Pass BOL number to updateTaskStatus
                    updateTaskStatus(vessel, customer, bol, taskId, newStatus);
                };
                
                let displayStatus = status;
                let statusClass = cssStatus;
                if (!task.customStates) {
                    displayStatus = status.replace(/-/g, ' ').toUpperCase();
                }

                // UPDATED: Use custom task description based on customer data
                const taskDescription = getTaskDescription(taskId, customerData);
                const formattedDescription = taskDescription.replace(/\n/g, '<br>');
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-number">${taskId}</div>
                        <div class="task-status status-${statusClass}">${displayStatus}</div>
                    </div>
                    <div class="task-name">${task.name}</div>
                    <div class="task-description">${formattedDescription}</div>
                    ${taskDate ? `<div class="task-date">üìÖ ${taskDate}</div>` : ''}
                `;
                
                container.appendChild(taskElement);
            });
        }

        function updateETA(vessel, customerName, blNo, newETA) {
            try {
                const vesselData = vesselsData.find(v => v.vessel === vessel);
                if (vesselData) {
                    // FIXED: Find customer by BOL number
                    const customerData = vesselData.customers.find(c => c.bol === blNo);
                    if (customerData) {
                        const oldETA = customerData.eta;
                        customerData.eta = newETA;
                        console.log(`‚úÖ Updated ETA for ${customerName} (BL: ${blNo}) from ${oldETA} to ${newETA}`);
                        
                        // Save to Google Sheets
                        saveETAToGoogleAppsScript(customerName, newETA);
                        
                        setTimeout(() => {
                            renderDashboard();
                            updateStatsOnly();
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error updating ETA:', error);
            }
        }

        function makeETAEditable(element, vessel, customerName, blNo, currentETA) {
            event.stopPropagation();
            
            const originalContent = element.innerHTML;
            
            try {
                const input = document.createElement('input');
                input.type = 'date';
                input.className = 'eta-input';
                input.value = currentETA;
                
                const saveAndRestore = () => {
                    try {
                        if (input.value && input.value !== currentETA) {
                            updateETA(vessel, customerName, blNo, input.value);
                        } else {
                            element.innerHTML = originalContent;
                        }
                    } catch (error) {
                        console.error('Error saving ETA:', error);
                        element.innerHTML = originalContent;
                    }
                };
                
                input.onblur = saveAndRestore;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        element.innerHTML = originalContent;
                    }
                };
                
                element.innerHTML = '';
                element.appendChild(input);
                
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 10);
                
            } catch (error) {
                console.error('Error creating ETA editor:', error);
                element.innerHTML = originalContent;
            }
        }

        // ADDED: Function to check if ETA is urgent (today or earlier)
        function isETAUrgent(etaDate) {
            if (!etaDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eta = new Date(etaDate);
            return eta <= today;
        }

        // ADDED: Count urgent tasks for a customer
        function countUrgentTasks(customerTasks, customerETA) {
            if (!isETAUrgent(customerETA)) return 0;
            
            let urgentCount = 0;
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                
                if (task && task.customStates) {
                    if (status !== task.customStates[task.customStates.length - 1]) {
                        urgentCount++;
                    }
                } else {
                    if (status !== 'completed') {
                        urgentCount++;
                    }
                }
            }
            return urgentCount;
        }

        // ADDED: Count urgent tasks for a vessel
        function countVesselUrgentTasks(vessel) {
            let urgentCount = 0;
            const customersToCount = vessel.filteredCustomers || vessel.customers;
            customersToCount.forEach(customer => {
                urgentCount += countUrgentTasks(customer.tasks, customer.eta);
            });
            return urgentCount;
        }

        function applyFilters(vessels) {
            const vesselFilter = document.getElementById('vesselFilter').value;
            const portFilter = document.getElementById('portFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const vesselStatusFilter = document.getElementById('vesselStatusFilter').value;
            const etaFromFilter = document.getElementById('etaFromFilter').value;
            const etaToFilter = document.getElementById('etaToFilter').value;
            const etsFromFilter = document.getElementById('etsFromFilter').value;
            const etsToFilter = document.getElementById('etsToFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            let filteredVessels = vessels.filter(vessel => {
                const vesselCompleted = isVesselCompleted(vessel);
                if (vesselStatusFilter === 'active' && vesselCompleted) return false;
                if (vesselStatusFilter === 'completed' && !vesselCompleted) return false;
                if (vesselFilter && vessel.vessel !== vesselFilter) return false;

                if (etsFromFilter || etsToFilter) {
                    const vesselEts = new Date(vessel.ets);
                    if (etsFromFilter && vesselEts < new Date(etsFromFilter)) return false;
                    if (etsToFilter && vesselEts > new Date(etsToFilter)) return false;
                }

                let filteredCustomers = vessel.customers.filter(customer => {
                    if (etaFromFilter || etaToFilter) {
                        const customerEta = new Date(customer.eta);
                        if (etaFromFilter && customerEta < new Date(etaFromFilter)) return false;
                        if (etaToFilter && customerEta > new Date(etaToFilter)) return false;
                    }
                    if (portFilter && customer.pod !== portFilter) return false;
                    return true;
                });

                if (filteredCustomers.length === 0) return false;

                if (statusFilter === 'incomplete') {
                    const hasIncompleteCustomers = filteredCustomers.some(customer => {
                        return hasIncompleteTasks(customer.tasks);
                    });
                    if (!hasIncompleteCustomers) return false;
                } else if (statusFilter === 'completed') {
                    const allCustomersCompleted = filteredCustomers.every(customer => {
                        return allTasksCompleted(customer.tasks);
                    });
                    if (!allCustomersCompleted) return false;
                }

                vessel.filteredCustomers = filteredCustomers;
                return true;
            });

            return sortVessels(filteredVessels, sortBy);
        }

        function hasIncompleteTasks(customerTasks) {
            for (let i = 1; i <= TASKS.length; i++) {
                const status = customerTasks[i];
                const task = TASKS.find(t => t.id === i);
                
                if (task && task.customStates) {
                    if (status === task.customStates[0]) return true;
                } else {
                    if (status === 'incomplete' || status === 'in-progress') return true;
                }
            }
            return false;
        }

        function isVesselCompleted(vessel) {
            if (!vessel.customers || vessel.customers.length === 0) return false;
            return vessel.customers.every(customer => allTasksCompleted(customer.tasks));
        }

        function sortVessels(vessels, sortBy) {
            const sorted = [...vessels];
            switch (sortBy) {
                case 'ets':
                    return sorted.sort((a, b) => new Date(a.ets) - new Date(b.ets));
                case 'eta':
                    return sorted.sort((a, b) => {
                        const aEarliestETA = Math.min(...a.customers.map(c => new Date(c.eta)));
                        const bEarliestETA = Math.min(...b.customers.map(c => new Date(c.eta)));
                        return aEarliestETA - bEarliestETA;
                    });
                case 'vessel':
                    return sorted.sort((a, b) => a.vessel.localeCompare(b.vessel));
                default:
                    return sorted;
            }
        }

        function getVesselETARange(vessel) {
            if (!vessel.customers || vessel.customers.length === 0) return null;
            const etas = vessel.customers.map(c => new Date(c.eta)).sort((a, b) => a - b);
            const earliest = etas[0];
            const latest = etas[etas.length - 1];
            
            if (earliest.getTime() === latest.getTime()) {
                return formatDate(earliest.toISOString().split('T')[0]);
            } else {
                return `${formatDate(earliest.toISOString().split('T')[0])} - ${formatDate(latest.toISOString().split('T')[0])}`;
            }
        }

        function getCurrentWeekDates() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            startOfWeek.setHours(0, 0, 0, 0);
            endOfWeek.setHours(23, 59, 59, 999);
            return { startOfWeek, endOfWeek };
        }

        function countArrivingThisWeek(vessels) {
            const { startOfWeek, endOfWeek } = getCurrentWeekDates();
            let count = 0;
            vessels.forEach(vessel => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                customersToCount.forEach(customer => {
                    const etaDate = new Date(customer.eta);
                    if (etaDate >= startOfWeek && etaDate <= endOfWeek) {
                        count++;
                    }
                });
            });
            return count;
        }

        function updateStatsOnly() {
            const filteredVessels = applyFilters(vesselsData);
            
            const totalVessels = filteredVessels.length;
            const totalCustomers = filteredVessels.reduce((sum, vessel) => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                return sum + customersToCount.length;
            }, 0);
            const arrivingThisWeek = countArrivingThisWeek(filteredVessels);
            
            // UPDATED: Calculate urgent tasks (ETA today or earlier with incomplete tasks)
            let urgentTasks = 0;
            filteredVessels.forEach(vessel => {
                const customersToCount = vessel.filteredCustomers || vessel.customers;
                customersToCount.forEach(customer => {
                    urgentTasks += countUrgentTasks(customer.tasks, customer.eta);
                });
            });
            
            document.getElementById('totalVessels').textContent = totalVessels;
            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('arrivingThisWeek').textContent = arrivingThisWeek;
            document.getElementById('urgentTasks').textContent = urgentTasks; // UPDATED: Changed from pendingTasks
        }

        function populateFilters() {
            const vesselFilter = document.getElementById('vesselFilter');
            const portFilter = document.getElementById('portFilter');
            
            const currentVessel = vesselFilter.value;
            const currentPort = portFilter.value;
            
            vesselFilter.innerHTML = '<option value="">All Vessels</option>';
            portFilter.innerHTML = '<option value="">All Ports</option>';
            
            const vessels = [...new Set(vesselsData.map(v => v.vessel))];
            const ports = [...new Set(vesselsData.flatMap(v => v.customers.map(c => c.pod)))];
            
            vessels.forEach(vessel => {
                const option = document.createElement('option');
                option.value = vessel;
                option.textContent = vessel;
                if (vessel === currentVessel) option.selected = true;
                vesselFilter.appendChild(option);
            });
            
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                if (port === currentPort) option.selected = true;
                portFilter.appendChild(option);
            });
        }

        function toggleVessel(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            const vesselInfo = header.querySelector('.vessel-info').textContent;
            const voyageMatch = vesselInfo.match(/Voyage: ([^|]+)/);
            const vesselName = header.querySelector('.vessel-title').textContent.replace('‚ñº', '').replace('‚ñ∂', '').trim();
            const voyage = voyageMatch ? voyageMatch[1].trim() : '';
            const vesselKey = `${vesselName}_${voyage}`;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                icon.textContent = '‚ñº';
                vesselCollapsedStates[vesselKey] = false;
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                icon.textContent = '‚ñ∂';
                vesselCollapsedStates[vesselKey] = true;
            }
        }

        function toggleTasksView(customerCard, customerId) {
            const container = customerCard.querySelector('.tasks-grid');
            const button = customerCard.querySelector('.show-all-btn');
            const isShowingAll = button.textContent.includes('Show Less');
            
            if (isShowingAll) {
                button.textContent = 'üìã Show All';
                renderCustomerTasks(container, customerId, false);
            } else {
                button.textContent = 'üìã Show Less';
                renderCustomerTasks(container, customerId, true);
            }
        }

        // UPDATED: Enhanced customer field update with Google Sheets saving using BL_No
        function updateCustomerField(vessel, customerName, blNo, field, value) {
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (vesselData) {
                // FIXED: Find customer by BOL number
                const customerData = vesselData.customers.find(c => c.bol === blNo);
                if (customerData) {
                    customerData[field] = value;
                    console.log(`Updated ${field} for ${customerName} (BL: ${blNo}) to ${value}`);
                    
                    // Save to Google Sheets using BL_No
                    saveCustomerToGoogleAppsScript(blNo, field === 'bnumber' ? 'BNumber' : field, value);
                }
            }
        }

        // UPDATED: Enhanced inland status toggle with Google Sheets saving using BL_No
        function toggleInlandStatus(vessel, customerName, blNo) {
            const vesselData = vesselsData.find(v => v.vessel === vessel);
            if (vesselData) {
                // FIXED: Find customer by BOL number
                const customerData = vesselData.customers.find(c => c.bol === blNo);
                if (customerData) {
                    customerData.inland = cycleInlandStatus(customerData.inland);
                    
                    // Save to Google Sheets using BL_No
                    saveCustomerToGoogleAppsScript(blNo, 'Inland', customerData.inland);
                    
                    // Update only the specific customer card with matching BOL
                    const safeBol = encodeURIComponent(blNo);
                    const customerId = `${vessel}|${customerName}|${safeBol}`;
                    const tasksContainer = document.getElementById(`tasks-${customerId}`);
                    if (tasksContainer) {
                        const customerCard = tasksContainer.closest('.customer-card');
                        const inlandBadge = customerCard.querySelector('.inland-badge');
                        if (inlandBadge) {
                            inlandBadge.className = `inland-badge ${getInlandClass(customerData.inland)}`;
                            inlandBadge.textContent = `Inland: ${getInlandDisplay(customerData.inland)}`;
                        }
                    }
                    
                    updateStatsOnly();
                }
            }
        }

        function renderDashboard() {
            const container = document.getElementById('vesselsContainer');
            
            const vesselHeaders = container.querySelectorAll('.vessel-header');
            vesselHeaders.forEach(header => {
                const vesselInfo = header.querySelector('.vessel-info').textContent;
                const voyageMatch = vesselInfo.match(/Voyage: ([^|]+)/);
                const vesselName = header.querySelector('.vessel-title').textContent.replace('‚ñº', '').replace('‚ñ∂', '').trim();
                const voyage = voyageMatch ? voyageMatch[1].trim() : '';
                const vesselKey = `${vesselName}_${voyage}`;
                vesselCollapsedStates[vesselKey] = header.classList.contains('collapsed');
            });
            
            container.innerHTML = '';
            
            const filteredVessels = applyFilters(vesselsData);
            
            filteredVessels.forEach(vessel => {
                const customersToShow = vessel.filteredCustomers || vessel.customers;
                const sortedCustomers = [...customersToShow].sort((a, b) => new Date(a.eta) - new Date(b.eta));
                
                const vesselCard = document.createElement('div');
                vesselCard.className = 'vessel-card';
                
                const vesselETA = getVesselETARange(vessel);
                const vesselUrgentTasks = countVesselUrgentTasks(vessel); // ADDED: Count urgent tasks for vessel
                
                vesselCard.innerHTML = `
                    <div class="vessel-header" onclick="toggleVessel(this)">
                        <div class="vessel-title">
                            ${vessel.vessel}
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="vessel-info">
                            Voyage: ${vessel.voyage} | ETS: ${formatDate(vessel.ets)} | ETA: ${vesselETA || 'N/A'} | ${sortedCustomers.length} Customer(s) | ‚ö†Ô∏è ${vesselUrgentTasks} Urgent
                        </div>
                    </div>
                    <div class="vessel-content">
                        ${sortedCustomers.map(customer => {
                            // FIXED: Include BOL in customerId with safe encoding
                            const safeBol = encodeURIComponent(customer.bol || '');
                            const customerId = `${vessel.vessel}|${customer.name}|${safeBol}`;
                            const nextTasks = getNextTasks(customer.tasks, 3);
                            
                            return `
                                <div class="customer-card">
                                    <div class="customer-header">
                                        <div class="customer-details-section">
                                            <div class="customer-name">
                                                <input type="text" value="${customer.name}" readonly
                                                       style="border: none; background: transparent; font-size: 0.9rem; font-weight: bold; color: #212529; width: 100%; padding: 1px;">
                                            </div>
                                            <div class="customer-details">
                                                B#: <input type="text" value="${customer.bnumber || ''}" 
                                                          onchange="updateCustomerField('${vessel.vessel}', '${customer.name}', '${customer.bol}', 'bnumber', this.value)"
                                                          style="border: none; background: transparent; color: #6c757d; padding: 1px; width: 60px;"
                                                          placeholder="B#">
                                                | BOL: <span class="bol-field">${customer.bol || 'N/A'}</span>
                                            </div>
                                            <div class="customer-details">
                                                Email: <input type="email" value="${customer.email || ''}" 
                                                              onchange="updateCustomerField('${vessel.vessel}', '${customer.name}', '${customer.bol}', 'Email', this.value)"
                                                              style="border: none; background: transparent; color: #6c757d; padding: 1px; width: 100%;"
                                                              placeholder="Email">
                                            </div>
                                        </div>
                                        <div class="customer-badges">
                                            <div class="eta-badge" onclick="event.stopPropagation(); makeETAEditable(this, '${vessel.vessel}', '${customer.name}', '${customer.bol}', '${customer.eta}')">
                                                ETA: ${formatDate(customer.eta)}
                                            </div>
                                            <div class="port-badge">${customer.pod}</div>
                                            <div class="inland-badge ${getInlandClass(customer.inland)}" 
                                                 onclick="toggleInlandStatus('${vessel.vessel}', '${customer.name}', '${customer.bol}')"
                                                 style="cursor: pointer;">
                                                ${getInlandDisplay(customer.inland)}
                                            </div>
                                        </div>
                                        <div style="grid-column: span 2;">
                                            <textarea class="customer-notes" 
                                                     onchange="updateCustomerField('${vessel.vessel}', '${customer.name}', '${customer.bol}', 'Notes', this.value)"
                                                     placeholder="Customer notes..."
                                                     rows="2">${customer.notes || ''}</textarea>
                                        </div>
                                    </div>
                                    <div class="tasks-container">
                                        <div class="tasks-header">
                                            <div class="tasks-title">üìã Next Tasks (${nextTasks.length} pending)</div>
                                            <button class="show-all-btn" onclick="toggleTasksView(this.closest('.customer-card'), '${customerId}')">üìã Show All</button>
                                        </div>
                                        <div class="tasks-grid" id="tasks-${customerId}">
                                            <!-- Tasks will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(vesselCard);
                
                const vesselKey = `${vessel.vessel}_${vessel.voyage}`;
                const vesselHeader = vesselCard.querySelector('.vessel-header');
                const vesselContent = vesselCard.querySelector('.vessel-content');
                const collapseIcon = vesselCard.querySelector('.collapse-icon');
                
                if (vesselCollapsedStates[vesselKey] === true) {
                    vesselHeader.classList.add('collapsed');
                    vesselContent.classList.add('collapsed');
                    collapseIcon.textContent = '‚ñ∂';
                }
                
                sortedCustomers.forEach(customer => {
                    // FIXED: Include BOL in customerId with safe encoding
                    const safeBol = encodeURIComponent(customer.bol || '');
                    const customerId = `${vessel.vessel}|${customer.name}|${safeBol}`;
                    const tasksContainer = document.getElementById(`tasks-${customerId}`);
                    renderCustomerTasks(tasksContainer, customerId, false);
                });
            });
            
            populateFilters();
        }

        function exportData() {
            alert('Export functionality would be implemented here');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const dataSourceElement = document.getElementById('dataSource');
            
            try {
                dataSourceElement.textContent = 'üîÑ Loading current data from Google Sheets...';
                
                const sheetsData = await loadFromGoogleAppsScript();
                if (sheetsData && sheetsData.length > 0) {
                    vesselsData = sheetsData;
                    originalVesselsData = JSON.parse(JSON.stringify(vesselsData));
                    dataSourceElement.textContent = `‚úÖ Current data loaded - ${sheetsData.length} vessel(s) | All task statuses current`;
                    console.log('‚úÖ Dashboard initialized with current Google Sheets data');
                } else {
                    dataSourceElement.textContent = '‚ö†Ô∏è No data found in Google Sheets';
                }
            } catch (error) {
                console.error('Auto-load error:', error);
                dataSourceElement.textContent = '‚ùå Cannot connect to Google Sheets - Check configuration';
                vesselsData = [];
                originalVesselsData = [];
            }
            
            renderDashboard();
            updateStatsOnly();
        });
    </script>
</body>
</html>
